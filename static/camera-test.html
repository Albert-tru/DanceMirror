<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‘„åƒå¤´æµ‹è¯• - DanceMirror</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }
        h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-line;
        }
        .status.info { background: #e3f2fd; color: #1976d2; border-left: 4px solid #1976d2; }
        .status.success { background: #e8f5e9; color: #388e3c; border-left: 4px solid #388e3c; }
        .status.error { background: #ffebee; color: #c62828; border-left: 4px solid #c62828; }
        .status.warning { background: #fff3e0; color: #f57c00; border-left: 4px solid #f57c00; }
        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        .video-container.active { display: block; }
        video { width: 100%; height: auto; display: block; }
        .controls { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .info-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .info-section h3 { color: #333; margin-bottom: 10px; font-size: 18px; }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .info-item:last-child { border-bottom: none; }
        .info-label { font-weight: 600; color: #495057; }
        .info-value { color: #6c757d; font-family: monospace; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¹ æ‘„åƒå¤´è®¿é—®æµ‹è¯•</h1>
        <div id="statusBox" class="status info">å‡†å¤‡æµ‹è¯•æµè§ˆå™¨æ‘„åƒå¤´å’Œéº¦å…‹é£è®¿é—®...</div>

        <div class="info-section">
            <h3>å½“å‰ç¯å¢ƒä¿¡æ¯</h3>
            <div class="info-item">
                <span class="info-label">è®¿é—®åœ°å€:</span>
                <span class="info-value" id="currentUrl">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">åè®®:</span>
                <span class="info-value" id="protocol">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">ä¸»æœºå:</span>
                <span class="info-value" id="hostname">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ˜¯å¦å®‰å…¨ä¸Šä¸‹æ–‡:</span>
                <span class="info-value" id="isSecure">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">MediaDevices æ”¯æŒ:</span>
                <span class="info-value" id="mediaSupport">-</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn-primary" onclick="startCamera()">ğŸ¥ æµ‹è¯•æ‘„åƒå¤´</button>
            <button class="btn-danger" onclick="stopCamera()" disabled id="stopBtn">â¹ åœæ­¢</button>
        </div>

        <div class="video-container" id="videoContainer">
            <video id="videoElement" autoplay playsinline muted></video>
        </div>
    </div>

    <script>
        let stream = null;
        const videoElement = document.getElementById('videoElement');
        const statusBox = document.getElementById('statusBox');
        const videoContainer = document.getElementById('videoContainer');
        const stopBtn = document.getElementById('stopBtn');

        function displayEnvironmentInfo() {
            document.getElementById('currentUrl').textContent = window.location.href;
            document.getElementById('protocol').textContent = window.location.protocol;
            document.getElementById('hostname').textContent = window.location.hostname;
            
            const isSecure = window.isSecureContext;
            const isSecureEl = document.getElementById('isSecure');
            isSecureEl.textContent = isSecure ? 'âœ… æ˜¯' : 'âŒ å¦';
            isSecureEl.style.color = isSecure ? '#388e3c' : '#c62828';
            
            const hasMediaDevices = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            const mediaSupportEl = document.getElementById('mediaSupport');
            mediaSupportEl.textContent = hasMediaDevices ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
            mediaSupportEl.style.color = hasMediaDevices ? '#388e3c' : '#c62828';
        }

        function showStatus(message, type = 'info') {
            statusBox.textContent = message;
            statusBox.className = 'status ' + type;
        }

        async function startCamera() {
            try {
                showStatus('æ­£åœ¨æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ...', 'info');

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ getUserMedia APIã€‚è¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chromeã€Firefox æˆ– Edge æµè§ˆå™¨ã€‚');
                }

                if (!window.isSecureContext) {
                    const hostname = window.location.hostname;
                    if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                        throw new Error('å½“å‰ä½¿ç”¨ ' + window.location.protocol + 'ï¼Œæ‘„åƒå¤´è®¿é—®éœ€è¦ HTTPS æˆ– localhost ç¯å¢ƒã€‚\n\nè¯·æ”¹ç”¨: http://localhost:' + (window.location.port || '8080') + '/static/camera-test.html');
                    }
                }

                showStatus('æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨å¼¹çª—ä¸­å…è®¸è®¿é—®...', 'info');

                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: true
                });

                videoElement.srcObject = stream;
                videoContainer.classList.add('active');
                stopBtn.disabled = false;

                const videoTrack = stream.getVideoTracks()[0];
                const audioTrack = stream.getAudioTracks()[0];
                const settings = videoTrack.getSettings();

                showStatus(
                    'âœ… æ‘„åƒå¤´è®¿é—®æˆåŠŸï¼\n' +
                    'è§†é¢‘: ' + settings.width + 'x' + settings.height + ' @ ' + settings.frameRate + 'fps\n' +
                    'æ‘„åƒå¤´: ' + videoTrack.label + '\n' +
                    'éº¦å…‹é£: ' + audioTrack.label,
                    'success'
                );

            } catch (error) {
                console.error('æ‘„åƒå¤´è®¿é—®å¤±è´¥:', error);
                
                let errorMessage = 'âŒ æ— æ³•è®¿é—®æ‘„åƒå¤´/éº¦å…‹é£\n\n';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += 'åŸå› : ç”¨æˆ·æ‹’ç»äº†æƒé™è¯·æ±‚\n';
                    errorMessage += 'è§£å†³: è¯·ç‚¹å‡»åœ°å€æ æ—çš„æ‘„åƒå¤´å›¾æ ‡ï¼Œé€‰æ‹©"å…è®¸"';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += 'åŸå› : æœªæ£€æµ‹åˆ°æ‘„åƒå¤´æˆ–éº¦å…‹é£è®¾å¤‡\n';
                    errorMessage += 'è§£å†³: è¯·æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²è¿æ¥';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += 'åŸå› : æ‘„åƒå¤´æ­£è¢«å…¶ä»–åº”ç”¨å ç”¨\n';
                    errorMessage += 'è§£å†³: è¯·å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„ç¨‹åºï¼ˆå¦‚ Zoomã€Teamsï¼‰';
                } else if (error.name === 'SecurityError') {
                    errorMessage += 'åŸå› : å®‰å…¨é™åˆ¶\n';
                    errorMessage += 'è§£å†³: å¿…é¡»ä½¿ç”¨ HTTPS æˆ–åœ¨ localhost ä¸‹è¿è¡Œ\n';
                    errorMessage += 'å½“å‰åœ°å€: ' + window.location.href + '\n';
                    errorMessage += 'å»ºè®®æ”¹ç”¨: http://localhost:' + (window.location.port || '8080') + '/static/camera-test.html';
                } else {
                    errorMessage += 'é”™è¯¯è¯¦æƒ…: ' + error.message;
                }
                
                showStatus(errorMessage, 'error');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            videoElement.srcObject = null;
            videoContainer.classList.remove('active');
            stopBtn.disabled = true;
            showStatus('æ‘„åƒå¤´å·²åœæ­¢', 'info');
        }

        window.addEventListener('load', function() {
            displayEnvironmentInfo();
            
            if (!window.isSecureContext) {
                const hostname = window.location.hostname;
                if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                    showStatus(
                        'âš ï¸ è­¦å‘Š: å½“å‰ä¸æ˜¯å®‰å…¨ä¸Šä¸‹æ–‡ (' + window.location.protocol + ')\n\n' +
                        'æ‘„åƒå¤´è®¿é—®éœ€è¦ HTTPS æˆ– localhost ç¯å¢ƒã€‚\n' +
                        'è¯·æ”¹ç”¨: http://localhost:' + (window.location.port || '8080') + '/static/camera-test.html',
                        'warning'
                    );
                }
            }
        });

        window.addEventListener('beforeunload', function() {
            stopCamera();
        });
    </script>
</body>
</html>
